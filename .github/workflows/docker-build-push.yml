name: ğŸ³ WebDiÃ¡rio Base Images - Build and Push to DockerHub

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
    paths:
      - 'webdiario-base-images/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'webdiario-base-images/**'

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_NAMESPACE: webdiario
  GRAFANA_VERSION: 10.2.0
  AWS_CLI_VERSION: 2.13.0
  GCLOUD_VERSION: 450.0.0
  JAVA_VERSION: 21
  NODE_VERSION: 22.17.1

jobs:
  # Build and push base images (Ubuntu)
  build-base-ubuntu:
    name: ğŸ§ Build Base Ubuntu
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/Dockerfile'))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-base
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GRAFANA_VERSION=${{ env.GRAFANA_VERSION }}

  build-base-alpine:
    name: ğŸ”ï¸ Build Base Alpine
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/alpine/Dockerfile'))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-base-alpine
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/alpine
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GRAFANA_VERSION=${{ env.GRAFANA_VERSION }}

  # Build and push AWS images (Ubuntu)
  build-aws-ubuntu:
    name: â˜ï¸ Build AWS Ubuntu
    runs-on: ubuntu-latest
    needs: build-base-ubuntu
    if: always() && (needs.build-base-ubuntu.result == 'success' || needs.build-base-ubuntu.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/aws/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-aws
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/aws
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            AWS_CLI_VERSION=${{ env.AWS_CLI_VERSION }}

  build-aws-java-ubuntu:
    name: â˜ï¸â˜• Build AWS Java Ubuntu
    runs-on: ubuntu-latest
    needs: build-aws-ubuntu
    if: always() && (needs.build-aws-ubuntu.result == 'success' || needs.build-aws-ubuntu.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/aws/java/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-aws-java
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/aws/java
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-aws-java-21-ubuntu:
    name: â˜ï¸â˜•21 Build AWS Java 21 Ubuntu
    runs-on: ubuntu-latest
    needs: build-aws-java-ubuntu
    if: always() && (needs.build-aws-java-ubuntu.result == 'success' || needs.build-aws-java-ubuntu.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/aws/java/21/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-aws-java-21
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/aws/java/21
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            JAVA_VERSION=${{ env.JAVA_VERSION }}

  build-aws-node-ubuntu:
    name: â˜ï¸ğŸ“¦ Build AWS Node Ubuntu
    runs-on: ubuntu-latest
    needs: build-aws-ubuntu
    if: always() && (needs.build-aws-ubuntu.result == 'success' || needs.build-aws-ubuntu.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/aws/node/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-aws-node
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/aws/node
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-aws-node-22-ubuntu:
    name: â˜ï¸ğŸ“¦22 Build AWS Node 22 Ubuntu
    runs-on: ubuntu-latest
    needs: build-aws-node-ubuntu
    if: always() && (needs.build-aws-node-ubuntu.result == 'success' || needs.build-aws-node-ubuntu.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/aws/node/22.17.1/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-aws-node-22.17.1
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/aws/node/22.17.1
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}

  # Build and push GCP images (Ubuntu)
  build-gcp-ubuntu:
    name: ğŸŒ Build GCP Ubuntu
    runs-on: ubuntu-latest
    needs: build-base-ubuntu
    if: always() && (needs.build-base-ubuntu.result == 'success' || needs.build-base-ubuntu.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/gcp/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-gcp
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/gcp
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GCLOUD_VERSION=${{ env.GCLOUD_VERSION }}

  build-gcp-java-ubuntu:
    name: ğŸŒâ˜• Build GCP Java Ubuntu
    runs-on: ubuntu-latest
    needs: build-gcp-ubuntu
    if: always() && (needs.build-gcp-ubuntu.result == 'success' || needs.build-gcp-ubuntu.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/gcp/java/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-gcp-java
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/gcp/java
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-gcp-java-21-ubuntu:
    name: ğŸŒâ˜•21 Build GCP Java 21 Ubuntu
    runs-on: ubuntu-latest
    needs: build-gcp-java-ubuntu
    if: always() && (needs.build-gcp-java-ubuntu.result == 'success' || needs.build-gcp-java-ubuntu.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/gcp/java/21/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-gcp-java-21
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/gcp/java/21
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            JAVA_VERSION=${{ env.JAVA_VERSION }}

  build-gcp-node-ubuntu:
    name: ğŸŒğŸ“¦ Build GCP Node Ubuntu
    runs-on: ubuntu-latest
    needs: build-gcp-ubuntu
    if: always() && (needs.build-gcp-ubuntu.result == 'success' || needs.build-gcp-ubuntu.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/gcp/node/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-gcp-node
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/gcp/node
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-gcp-node-22-ubuntu:
    name: ğŸŒğŸ“¦22 Build GCP Node 22 Ubuntu
    runs-on: ubuntu-latest
    needs: build-gcp-node-ubuntu
    if: always() && (needs.build-gcp-node-ubuntu.result == 'success' || needs.build-gcp-node-ubuntu.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/gcp/node/22.17.1/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-gcp-node-22.17.1
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/gcp/node/22.17.1
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}

  # Build and push Alpine images
  build-aws-alpine:
    name: â˜ï¸ğŸ”ï¸ Build AWS Alpine
    runs-on: ubuntu-latest
    needs: build-base-alpine
    if: always() && (needs.build-base-alpine.result == 'success' || needs.build-base-alpine.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/alpine/aws/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-aws-alpine
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/alpine/aws
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            AWS_CLI_VERSION=${{ env.AWS_CLI_VERSION }}

  build-gcp-alpine:
    name: ğŸŒğŸ”ï¸ Build GCP Alpine
    runs-on: ubuntu-latest
    needs: build-base-alpine
    if: always() && (needs.build-base-alpine.result == 'success' || needs.build-base-alpine.result == 'skipped') && (github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.changed_files, 'webdiario-base-images/alpine/gcp/')))
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to DockerHub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-gcp-alpine
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./webdiario-base-images/alpine/gcp
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GCLOUD_VERSION=${{ env.GCLOUD_VERSION }}

  # Security scanning
  security-scan:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    needs: [build-base-ubuntu, build-base-alpine, build-aws-java-21-ubuntu, build-gcp-java-21-ubuntu, build-aws-node-22-ubuntu, build-gcp-node-22-ubuntu, build-aws-alpine, build-gcp-alpine]
    if: always() && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ” Run Trivy vulnerability scanner on base images
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/webdiario-base:latest'
          format: 'sarif'
          output: 'trivy-base-results.sarif'

      - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-base-results.sarif'

  # Notification
  notify:
    name: ğŸ“¢ Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-base-ubuntu, build-base-alpine, build-aws-java-21-ubuntu, build-gcp-java-21-ubuntu, build-aws-node-22-ubuntu, build-gcp-node-22-ubuntu, build-aws-alpine, build-gcp-alpine, security-scan]
    if: always() && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¢ Notify on success
        if: ${{ needs.build-base-ubuntu.result == 'success' && needs.build-base-alpine.result == 'success' && needs.build-aws-java-21-ubuntu.result == 'success' && needs.build-gcp-java-21-ubuntu.result == 'success' && needs.build-aws-node-22-ubuntu.result == 'success' && needs.build-gcp-node-22-ubuntu.result == 'success' && needs.build-aws-alpine.result == 'success' && needs.build-gcp-alpine.result == 'success' }}
        run: |
          echo "âœ… All WebDiÃ¡rio base images built and pushed successfully!"
          echo "ğŸ³ Images available at: https://hub.docker.com/u/${{ env.DOCKER_NAMESPACE }}"
          echo "ğŸ“‹ Available images:"
          echo "  - webdiario-base (Ubuntu)"
          echo "  - webdiario-base-alpine (Alpine)"
          echo "  - webdiario-aws-java-21 (Ubuntu)"
          echo "  - webdiario-gcp-java-21 (Ubuntu)"
          echo "  - webdiario-aws-node-22.17.1 (Ubuntu)"
          echo "  - webdiario-gcp-node-22.17.1 (Ubuntu)"
          echo "  - webdiario-aws-alpine (Alpine)"
          echo "  - webdiario-gcp-alpine (Alpine)"

      - name: ğŸ“¢ Notify on failure
        if: ${{ needs.build-base-ubuntu.result == 'failure' || needs.build-base-alpine.result == 'failure' || needs.build-aws-java-21-ubuntu.result == 'failure' || needs.build-gcp-java-21-ubuntu.result == 'failure' || needs.build-aws-node-22-ubuntu.result == 'failure' || needs.build-gcp-node-22-ubuntu.result == 'failure' || needs.build-aws-alpine.result == 'failure' || needs.build-gcp-alpine.result == 'failure' }}
        run: |
          echo "âŒ Some WebDiÃ¡rio base images failed to build or push!"
          echo "Check the logs for more details."
